name: Release

on:
  push:
    tags:
      - 'v*'

env:
  GO_VERSION: ${{ vars.GO_VERSION }}
  POSTGRES_DSN: ${{ secrets.POSTGRES_DSN }}

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download

      - name: Run migrations
        run: go run . migrate --dsn="${{ env.POSTGRES_DSN }}"

      - name: Run tests
        run: go test -v ./...

  build:
    name: Build and Push
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set tag name
        run: |
          echo "TAG_NAME=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=%an)" >> $GITHUB_ENV

      - name: Build Docker image
        run: docker build -f Dockerfile -t stakely/kuiper-signer:${{ env.TAG_NAME }} .

      - name: Login to DockerHub
        run: echo '${{ secrets.DOCKERHUB_PASSWORD }}' | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      - name: Push Docker image
        run: docker push stakely/kuiper-signer:${{ env.TAG_NAME }}

  notify:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set commit info
        run: |
          echo "TAG_NAME=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=%an)" >> $GITHUB_ENV

      - name: Determine workflow status
        id: status
        run: |
          if [[ "${{ needs.test.result }}" == "failure" || "${{ needs.build.result }}" == "failure" ]]; then
            echo "result=failure" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.test.result }}" == "cancelled" || "${{ needs.build.result }}" == "cancelled" ]]; then
            echo "result=cancelled" >> $GITHUB_OUTPUT
          else
            echo "result=success" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification on success
        if: steps.status.outputs.result == 'success'
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: 'GitHub Actions'
          avatar-url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'
          embed-color: '3066993'
          embed-description: |
            Release _${{ env.TAG_NAME }}_ for repository https://github.com/${{ github.repository }} has been published.
            Docker image `stakely/kuiper-signer:${{ env.TAG_NAME }}` is now available.
            - **Commit**: _${{ env.COMMIT_MESSAGE }}_ by _${{ env.COMMIT_AUTHOR }}_
            - **Tag**: ${{ env.TAG_NAME }}
            - **Status**: Success

      - name: Send Discord notification on failure
        if: steps.status.outputs.result == 'failure'
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: 'GitHub Actions'
          avatar-url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'
          embed-color: '15158332'
          embed-description: |
            Error with the release workflow for tag _${{ env.TAG_NAME }}_ in https://github.com/${{ github.repository }}/actions.
            Release was not published.
            - **Commit**: _${{ env.COMMIT_MESSAGE }}_ by _${{ env.COMMIT_AUTHOR }}_
            - **Tag**: ${{ env.TAG_NAME }}
            - **Status**: Failed

