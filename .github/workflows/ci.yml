name: CI

on:
  push:
    branches:
      - develop
      - main

env:
  GO_VERSION: ${{ vars.GO_VERSION }}
  POSTGRES_DSN: ${{ secrets.POSTGRES_DSN }}

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download

      - name: Run migrations
        run: go run . migrate --dsn="${{ env.POSTGRES_DSN }}"

      - name: Run tests
        run: go test -v ./...

  build:
    name: Build and Push
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set commit info
        run: |
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=%an)" >> $GITHUB_ENV
          echo "BRANCH_NAME=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Build Docker image
        run: docker build -f Dockerfile -t stakely/kuiper-signer:latest .

      - name: Login to DockerHub
        run: echo '${{ secrets.DOCKERHUB_PASSWORD }}' | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      - name: Push Docker image
        run: docker push stakely/kuiper-signer:latest

  notify:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set commit info
        run: |
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=%an)" >> $GITHUB_ENV
          echo "BRANCH_NAME=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Determine workflow status and summary
        id: status
        run: |
          # Determine overall status
          if [[ "${{ needs.test.result }}" == "failure" || "${{ needs.build.result }}" == "failure" ]]; then
            echo "result=failure" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.test.result }}" == "cancelled" || "${{ needs.build.result }}" == "cancelled" ]]; then
            echo "result=cancelled" >> $GITHUB_OUTPUT
          else
            echo "result=success" >> $GITHUB_OUTPUT
          fi

          # Determine what was executed
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "workflow_type=full" >> $GITHUB_OUTPUT
            echo "summary=Tests + Build + Push to DockerHub (stakely/kuiper-signer:latest)" >> $GITHUB_OUTPUT
          else
            echo "workflow_type=tests_only" >> $GITHUB_OUTPUT
            echo "summary=Tests only (no build on develop)" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification on success
        if: steps.status.outputs.result == 'success'
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: 'GitHub Actions'
          avatar-url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'
          embed-color: '3066993'
          embed-description: |
            ✅ **${{ steps.status.outputs.summary }}**

            Repository: https://github.com/${{ github.repository }}/tree/${{ env.BRANCH_NAME }}
            - **Commit**: _${{ env.COMMIT_MESSAGE }}_ by _${{ env.COMMIT_AUTHOR }}_
            - **Branch**: `${{ github.ref_name }}`

      - name: Send Discord notification on failure
        if: steps.status.outputs.result == 'failure'
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: 'GitHub Actions'
          avatar-url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'
          embed-color: '15158332'
          embed-description: |
            ❌ **Pipeline failed: ${{ steps.status.outputs.summary }}**

            Check logs: https://github.com/${{ github.repository }}/actions
            - **Commit**: _${{ env.COMMIT_MESSAGE }}_ by _${{ env.COMMIT_AUTHOR }}_
            - **Branch**: `${{ github.ref_name }}`
            - **Test**: ${{ needs.test.result }}
            - **Build**: ${{ needs.build.result }}

